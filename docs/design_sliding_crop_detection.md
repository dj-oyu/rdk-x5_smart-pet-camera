# スライドクロップ検出方式の検討

## 概要

高解像度入力（1920x1080）からYOLO推論用の640x640入力を生成する際、単純なリサイズやletterboxではなく、元解像度を活かしてクロップ位置をずらしながら複数回推論する方式の検討。

## 現状の方式

### 1. 単純リサイズ（現在の実装）
```
1920x1080 → 640x640 (ストレッチ)
```
- アスペクト比が歪む（16:9 → 1:1）
- 物体が縦に引き伸ばされ、検出精度に影響

### 2. Letterbox（実装予定）
```
1920x1080 → 640x360 (アスペクト比維持) → 640x640 (上下黒帯)
```
- アスペクト比維持
- 解像度は1/3に低下

## 提案: スライドクロップ方式

### 基本アイデア

元の1920x1080解像度から640x640の領域を複数クロップし、それぞれ推論後に結果をマージ。

```
1920x1080 フレーム
┌────────────────────────────────────────────────────────┐
│                                                        │
│   ┌──────────┐                                         │
│   │  Crop 1  │  ← 左端 (x=0)                          │
│   │  640x640 │                                         │
│   └──────────┘                                         │
│          ┌──────────┐                                  │
│          │  Crop 2  │  ← 中央 (x=640)                 │
│          │  640x640 │                                  │
│          └──────────┘                                  │
│                 ┌──────────┐                           │
│                 │  Crop 3  │  ← 右端 (x=1280)         │
│                 │  640x640 │                           │
│                 └──────────┘                           │
└────────────────────────────────────────────────────────┘
```

### クロップ位置の計算例

入力: 1920x1080、クロップサイズ: 640x640

**垂直方向:**
- 高さ1080に対して640をクロップ → 上下220pxずつトリミング
- y_offset = (1080 - 640) / 2 = 220

**水平方向（3分割）:**
- Crop 1: x=0, y=220
- Crop 2: x=640, y=220
- Crop 3: x=1280, y=220 (実際は1920-640=1280)

**オーバーラップあり（2分割）:**
- Crop 1: x=0, y=220
- Crop 2: x=1280, y=220
- オーバーラップ: 640 - (1920-1280) = 0px（この例ではなし）

## Pros（メリット）

### 1. 高解像度維持
- 元の解像度（1920x1080）をそのまま使用
- 小さな物体の検出精度が向上
- 遠くにいるペットや小型ペットの検出に有利

### 2. アスペクト比の歪みなし
- 640x640の正方形クロップなので歪みなし
- YOLOの学習データと同じ条件

### 3. 検出漏れの減少
- letterboxでは縮小により失われる細部を保持
- 画面端の物体も検出可能

### 4. 動的クロップ位置
- 前フレームの検出結果に基づいてクロップ位置を最適化可能
- 追跡対象がいる領域を優先的に推論

## Cons（デメリット）

### 1. 推論時間の増加
- 3クロップの場合: 推論時間が約3倍
- 現在の推論時間: 約30-50ms → 90-150ms
- フレームレート: 30fps → 7-10fps程度

### 2. マージ処理の複雑さ
- オーバーラップ領域での重複検出
- クロップ間NMS（Non-Maximum Suppression）が必要
- 座標変換の実装が複雑

### 3. レイテンシ増加
- 1フレームあたりの処理時間が増加
- リアルタイム性が低下

### 4. BPU使用率の増加
- BPU（AI処理ユニット）の負荷が増加
- 他のAI処理との競合の可能性

### 5. 垂直方向の情報損失
- 高さ1080から640をクロップするため、上下220pxがカット
- 天井や床に近い領域は検出できない

## 実装の複雑さ

### 必要な追加実装

1. **クロップ生成**
   ```python
   def generate_crops(frame, crop_size=640, overlap=0.2):
       crops = []
       stride = int(crop_size * (1 - overlap))
       for x in range(0, frame_width - crop_size + 1, stride):
           crop = frame[y_offset:y_offset+crop_size, x:x+crop_size]
           crops.append((crop, x, y_offset))
       return crops
   ```

2. **座標変換**
   ```python
   def transform_bbox(bbox, crop_x, crop_y):
       return BoundingBox(
           x=bbox.x + crop_x,
           y=bbox.y + crop_y,
           w=bbox.w,
           h=bbox.h
       )
   ```

3. **クロップ間NMS**
   ```python
   def merge_detections(all_detections, iou_threshold=0.5):
       # 全クロップの検出結果を統合
       # IoUが高い重複を除去
       pass
   ```

## 代替案

### ハイブリッド方式

1. **通常時**: Letterbox方式（30fps維持）
2. **検出時**: 検出された領域周辺を高解像度で再推論

```
Frame N: Letterbox推論 → ペット検出 (x=800, y=400)
Frame N+1: 検出位置周辺を640x640クロップで再推論
           → より正確なbboxを取得
```

### 適応的クロップ

- 動き検出と組み合わせ
- 動きがある領域のみ高解像度推論
- 静止フレームはLetterboxでスキップ

## 推奨事項

### 短期（現在）
1. まずLetterbox方式を実装・評価
2. 検出精度のベースラインを確立

### 中期（精度課題がある場合）
1. ハイブリッド方式を検討
2. 検出後の追跡領域のみ高解像度化

### 長期（リソースに余裕がある場合）
1. フルスライドクロップ方式の実装
2. BPU並列推論の活用（可能であれば）

## 参考: フレームレートへの影響

| 方式 | 推論回数/フレーム | 推定FPS | 備考 |
|------|------------------|---------|------|
| 単純リサイズ | 1 | 20-30 | 現状 |
| Letterbox | 1 | 20-30 | 精度向上 |
| 2クロップ | 2 | 10-15 | 左右カバー |
| 3クロップ | 3 | 7-10 | フルカバー |
| ハイブリッド | 1-2 | 15-25 | 適応的 |

## 結論

スライドクロップ方式は検出精度向上に有効だが、リアルタイム性とのトレードオフがある。ペットカメラの用途では、まずLetterbox方式で十分な精度が得られるか評価し、必要に応じてハイブリッド方式を検討するのが現実的。
