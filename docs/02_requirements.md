# 要件定義 - スマートペットカメラ

## 機能要件

### FR-01: 映像キャプチャ機能
- **FR-01-01**: システムは2基のカメラ（昼間用・夜間用）から同時に映像をキャプチャできる
- **FR-01-02**: 昼夜の環境に応じて適切なカメラを自動選択または両方を使用できる
- **FR-01-03**: 映像キャプチャは30fps以上のフレームレートを維持する
- **FR-01-04**: キャプチャした映像はリアルタイムで処理パイプラインに渡される

### FR-02: 物体検出機能
- **FR-02-01**: システムは映像フレームから猫の体を検出できる
- **FR-02-02**: システムは餌皿（食事エリア）を検出できる
- **FR-02-03**: システムは水飲み場を検出できる
- **FR-02-04**: 検出結果にはバウンディングボックス（座標、幅、高さ）とクラス名、信頼度が含まれる
- **FR-02-05**: 物体検出の推論時間はフレーム間隔内（33ms以内 for 30fps）に完了する

### FR-03: 行動推定機能
- **FR-03-01**: 猫のバウンディングボックスと餌皿のバウンディングボックスの重なり具合から食事行動を推定する
- **FR-03-02**: 猫のバウンディングボックスと水飲み場のバウンディングボックスの重なり具合から水飲み行動を推定する
- **FR-03-03**: 重なり閾値（IoU: Intersection over Union等）を設定可能とする
- **FR-03-04**: 行動開始時刻と終了時刻を記録する
- **FR-03-05**: 誤検出を減らすため、一定時間（例：3秒以上）継続した行動のみを記録する

### FR-04: データ記録機能
- **FR-04-01**: 検出された行動イベントをJSON形式で記録する
- **FR-04-02**: JSON記録には以下の情報を含める：
  - タイムスタンプ
  - 行動種別（食事/水飲み）
  - 行動開始時刻
  - 行動終了時刻
  - 信頼度
  - 使用カメラID
- **FR-04-03**: 行動イベント発生時の映像を動画ファイルとして保存する
- **FR-04-04**: 動画ファイルは行動開始数秒前から終了数秒後まで含める
- **FR-04-05**: 動画ファイル名とJSONデータは関連付け可能な命名規則を持つ

### FR-05: データ管理機能
- **FR-05-01**: 記録データは日付ごとにディレクトリ分けして保存する
- **FR-05-02**: ストレージ容量を監視し、空き容量が一定以下になったら警告を出す
- **FR-05-03**: 古いデータを自動削除する機能を提供する（設定可能な保持期間）

### FR-06: 設定管理機能
- **FR-06-01**: カメラパラメータ（解像度、フレームレート等）を設定ファイルで管理できる
- **FR-06-02**: 物体検出モデルのパスと設定を指定できる
- **FR-06-03**: 行動推定の閾値を設定できる
- **FR-06-04**: 記録保存先のパスを設定できる

## 非機能要件

### NFR-01: パフォーマンス
- **NFR-01-01**: システムは24時間連続稼働可能である
- **NFR-01-02**: メモリリークが発生しない
- **NFR-01-03**: CPU使用率は平均80%以下を維持する
- **NFR-01-04**: フレーム処理の遅延は100ms以内とする

### NFR-02: 信頼性
- **NFR-02-01**: システムクラッシュ時に自動再起動する
- **NFR-02-02**: データ記録中の電源断に対して、可能な限りデータを保護する
- **NFR-02-03**: カメラ接続エラー時にリトライ処理を行う
- **NFR-02-04**: エラーログを記録し、デバッグを容易にする

### NFR-03: 保守性
- **NFR-03-01**: コードはモジュール化され、各機能が独立している
- **NFR-03-02**: 設定変更はコード変更なしに可能である
- **NFR-03-03**: ログ出力は適切なレベル（DEBUG, INFO, WARN, ERROR）で分類される
- **NFR-03-04**: ドキュメントが整備され、システムの理解が容易である

### NFR-04: 拡張性
- **NFR-04-01**: 新しい行動パターンの追加が容易である
- **NFR-04-02**: 物体検出モデルの差し替えが容易である
- **NFR-04-03**: カメラ台数の増減に対応可能な設計である

## システム要件

### ハードウェア要件
- **HW-01**: カメラモジュール × 2（昼間用・夜間用または標準+IR対応）
- **HW-02**: 組み込みLinuxボード（ARM/x86_64）
- **HW-03**: メモリ：最低2GB RAM
- **HW-04**: ストレージ：最低32GB（推奨64GB以上）
- **HW-05**: GPU/NPU：推論アクセラレータ（推奨）

### ソフトウェア要件
- **SW-01**: OS: Linux（カーネル4.x以上）
- **SW-02**: カメラドライバ: V4L2対応
- **SW-03**: C/C++コンパイラ: GCC 7.x以上
- **SW-04**: Python: 3.7以上（物体検出処理用）
- **SW-05**: OpenCV: 4.x以上
- **SW-06**: 物体検出フレームワーク: TensorFlow Lite / ONNX Runtime / PyTorch等

### ネットワーク要件
- **NW-01**: 初期フェーズではネットワーク接続は必須ではない
- **NW-02**: 将来的な拡張のため、ネットワークインターフェースを持つことが望ましい

## データ要件

### DR-01: 記録データフォーマット

#### JSON記録フォーマット例
```json
{
  "event_id": "20250101_120530_001",
  "timestamp": "2025-01-01T12:05:30.123Z",
  "event_type": "eating",
  "start_time": "2025-01-01T12:05:30.123Z",
  "end_time": "2025-01-01T12:07:15.456Z",
  "duration_seconds": 105.333,
  "camera_id": "cam_day",
  "confidence": 0.92,
  "video_file": "20250101_120530_001.mp4",
  "detections": [
    {
      "frame_number": 1850,
      "cat_bbox": {"x": 320, "y": 240, "w": 150, "h": 180},
      "food_bowl_bbox": {"x": 300, "y": 280, "w": 100, "h": 80},
      "overlap_iou": 0.35
    }
  ]
}
```

### DR-02: ディレクトリ構造
```
/data/smart-pet-camera/
├── 2025-01-01/
│   ├── events.jsonl          # 日次イベントログ（JSON Lines形式）
│   ├── 20250101_120530_001.mp4
│   ├── 20250101_120530_001.json
│   ├── 20250101_143022_002.mp4
│   └── 20250101_143022_002.json
├── 2025-01-02/
│   └── ...
└── metadata/
    ├── camera_status.json
    └── system_stats.json
```

### DR-03: データ保持ポリシー
- 動画ファイル: 7日間保持（設定変更可能）
- JSONイベントログ: 90日間保持（設定変更可能）
- システムログ: 30日間保持

## 制約事項

### C-01: 技術的制約
- 組み込みデバイスのため、リソース（CPU、メモリ、ストレージ）に制限がある
- リアルタイム処理が必要なため、重い物体検出モデルは使用できない

### C-02: 環境的制約
- 照明条件が変化する（昼夜、室内照明のON/OFF）
- カメラ位置は固定される

### C-03: 運用的制約
- 初期段階では人手による定期的な確認とチューニングが必要
- ネットワーク接続がない環境でも動作する必要がある

## 優先度

### 必須（P0）
- FR-01（映像キャプチャ）
- FR-02（物体検出）
- FR-03（行動推定）
- FR-04（データ記録）
- NFR-01（パフォーマンス）
- NFR-02（信頼性）

### 高（P1）
- FR-05（データ管理）
- FR-06（設定管理）
- NFR-03（保守性）

### 中（P2）
- NFR-04（拡張性）
- FR-05-03（古いデータの自動削除）

### 低（P3 - 将来的に検討）
- リアルタイムアラート
- Web UIダッシュボード
- クラウド連携
