# カメラ切り替えプローブ対応の現状と今後

> **📝 2026-01-21 更新**: このドキュメントに記載されていたプローブ問題は解決済みです。
>
> **解決方法**: フレーム全体をプローブ用共有メモリに書き込む代わりに、軽量な明るさ専用共有メモリ (`/pet_camera_brightness`, ~100 bytes) を導入しました。各カメラデーモンが常時明るさデータを更新するため、SIGRTMIN によるプローブ要求やリングバッファ競合の問題が解消されました。
>
> 詳細は `shared_memory.h` の `SharedBrightnessData` 構造体を参照してください。

---

## (以下は過去の経緯記録)

## 経緯まとめ
- **初期問題**: NIGHTカメラ常時書き込み中にDAYカメラを1-shotプローブすると、共有メモリのリングバッファがすぐ上書きされ、プローブフレームを拾えず明るさ判定が常に低値になる。
- **修正1** (`capture_frame_cb`): 1-shot開始前の`write_index`をスナップショットし、完了後に差分範囲のみ走査。見つけたフレームを即`memcpy`で退避。  
  - 期待効果: アクティブカメラの連続書き込みがあっても、プローブ後に新規書き込み分だけを見ることで取りこぼしを減らす。
- **修正2** (`capture_frame_cb`): 走査回数を拡大（最大20回、約400ms）。  
  - 期待効果: プローブから反映まで遅延があっても拾える時間を確保。
- **現状**: 実機でNIGHT→DAY切り替えが依然発生せず。1-shot起動自体は動作しているが、プローブ後に`out_frame`へコピーするまでの間にリングバッファが周回・上書きしている可能性が指摘された。

## 追加で疑われる点
- プローブ完了から`capture_frame_cb`でコピーするまでの時間が長く、`write_index`差分がリングサイズ（`RING_BUFFER_SIZE=30`）を超えている。
- `frame_calculate_mean_luma`が`data_size`不足や想定外`format`で-1を返し、明るさが記録されていない。
- 切り替え判定後に`switch_camera_cb`/`spawn_daemon`が失敗しているが、現在ログで十分に可視化されていない。

## 今後の方針案
1. **バッファ溢れ検知と即時コピーの強化**  
   - プローブ開始直後に`start_write_index`を記録し、プローブ完了後は`current_write_index - start_write_index`が`RING_BUFFER_SIZE`以上なら「オーバーフロー疑い」としてログ。  
   - 差分走査中に見つけたフレームは即`memcpy`で退避済みだが、差分が大きく走査コストが増える場合は`current_write_index`直前から逆順で数件を先にチェックするなど、見つけやすい順序に変更を検討。
2. **フォーマット/サイズの健全性チェック**  
   - プローブ取得後に`format`と`data_size`を検証し、`frame_calculate_mean_luma`が-1を返す原因をログする（JPEGは`data_size>0`、NV12は`width*height*3/2`以上など）。
3. **切り替えパス全体の可視化**  
   - `camera_switcher_handle_frame`の返却値、閾値比較の途中経過、`switch_camera`の戻り値、`spawn_daemon`の成否をログで追えるようにする。
4. **プローブ→コピーまでの遅延短縮**  
   - プローブ1-shot完了直後に最終`write_index`を再取得し、走査回数を現在の時間待ち依存から「必要な差分件数のみ」に縮小して遅延を抑える。
5. **最終手段: プローブ専用共有メモリorダイレクトコピー**  
   - どうしてもリング上書き競合を避けられない場合、1-shotデーモンからパイプ/一時共有メモリで直接`probe_frame`を受け取る案を検討。

## すぐできる調査タスク（優先度順）
1. `current_write_index - start_write_index >= RING_BUFFER_SIZE`の検知ログを追加し、現象再現時に確認する。  
2. プローブ取得直後の`format`/`data_size`チェックと、`frame_calculate_mean_luma`の結果ログを追加する。  
3. `switch_camera`と`spawn_daemon`の成功/失敗ログを強化し、切り替え要求が到達しているか確認する。  
4. 差分走査の順序最適化（最新側優先）を試し、リング周回時の捕捉率を上げる。  
5. それでも失敗する場合は、プローブ専用パス（別shmや直送）の実装に着手する。
